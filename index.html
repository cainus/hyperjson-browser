<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>percolator.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }

      pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
      .string { color: green; }
      .number { color: darkorange; }
      .boolean { color: blue; }
      .null { color: magenta; }
      .key { color: black; }

    </style>
    <link href="css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="js/superagent.js"></script>
    <script src="js/bootbox.min.js"></script>
    <script src="js/underscore-min.js"></script>
    <script src="js/uri-template.js"></script>
    <script>

      function uriParse(uri){
        var parsed = document.createElement('a');
        // parsed has these properties:   protocol, hostname, port, pathname, search, hash, host
        parsed.href = uri;
        return parsed;
      }

      function qs(key) {
        var re=new RegExp('(?:\\?|&)'+key+'=(.*?)(?=&|$)','gi');
        var r=[], m;
        while ((m=re.exec(document.location.search)) !== null){
          r.push(unescape(m[1]));
        }
        return r;
      }

       function htmlEncode(str){
         return str;
         return str.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
       }

       function relativeLink(href){
         var parsed = uriParse(href);
         var hostIndex = href.indexOf(parsed.host);
         if (hostIndex != -1){
           return href.slice(hostIndex + parsed.host.length);
         }
         return href;
       }

       function linkify(_links){
         console.log("links in: ", _links);
         for(linkname in _links){
           var v = _links[linkname];
           if (!!v.method){
             if (v.method === "DELETE"){
               v.href = "<a class='deleteLink' href='#'>" + v.href + '</a>';
             }
             if (v.method === "PUT"){
               v.href = "<a class='putLink' href='#'>" + v.href + '</a>';
             }
           } else {
             v.href = "<a href='?href=" + escape(relativeLink(v.href)) + "'>" + v.href + '</a>';
           }
           if (v.method){
             v.method = '<strong>' + v.method + '</strong>';
           }
         };
         console.log('links out: ', _links);
         return _links;
       }

       function traverse(obj,func) {
         _.each(obj, function(v, k){
           if (func(k,v,obj)){
             if (typeof(v)=="object") {
               //going on step down in the object tree!!
               traverse(v,func);
             }
           }
         });
       }

       function formatKeyValue(key, value, obj){
           console.log("called handler");
           if (key === "_links"){
             console.log("linkifying");
             obj['<strong>_links</strong>'] = linkify(value);
             delete obj._links;
             return false;
           } else {
             if (typeof value === 'string'){
               console.log("string: ", value);
               obj[key] = htmlEncode(value);
             }
             return true;
           }
       }

       function render(obj){
         traverse(obj, formatKeyValue);
         console.log('pre-stringify: ', obj);

         var json = JSON.stringify(obj, null, 4);
         console.log('post-stringify: ', json);
         return json;
       }

       function headersToHtml(headers){
         var html = '';
         for(var k in headers){
           v = headers[k];
           html += '<dl class="dl-horizontal"><dt>' + k + '</dt><dd>' + v + '</dd></dl>';
         }
         return html;
       }

       function statusToHtml(status){
         var type = '';
         switch(true){
           case (status >= 200 && status < 300) : type = 'badge-success'; break;
           case (status >= 300 && status < 400) : type = 'badge-info'; break;
           case (status >= 400) : type = 'badge-important'; break;
         }
         return '<span class="badge ' + type + '">' + status + '</span>';
       }

       var uriParamNames = [];

       function getInputForm(method, url, schema){
         var retval = "url " + url + " .";
         var urlParams = url.match(/{([^}]+)}/g);
         uriParamNames = [];
         retval += '<form class="inputForm">';
         if (urlParams.length > 0){
           retval += '<fieldset>';
           retval += '<legend>URL Parameters</legend>';
           _.each(urlParams, function(param){
             var name = param.slice(1, -1);
             uriParamNames.push(name)
             retval += '<label>';
             retval += name + ': <input type="text" name="URI_PARAM_';
             retval += name + '" value="" />';
             retval += '</label>';
           });
           retval += '</fieldset>';
         }
         retval += '<fieldset>';
         retval += '<legend>Body</legend>';
         retval += '<textarea name="body"></textarea>';
         retval += '</form>';
         return retval;
       }

       function getUriParamFormField(name){
         //console.log("checking: ", name);
         var retval = $("form.inputForm input[name=URI_PARAM_" + name + "]").val()
         //console.log("returning: ", retval);
         return retval;
       }

       function retrieveUrl(url){
          superagent
            .get(url)
            .set('Accept', 'application/json')
            .end(function(res){
              $('#responseStatus').html(statusToHtml(res.status));
              $('#responseHeaders').html(headersToHtml(res.header));

              console.log("body ", typeof res.body, res.body);
              console.log("text ", typeof res.text, res.text);
              var body = res.body;
              body = JSON.parse(res.text);
              console.log("cleaned ", typeof body , body);
              console.log("cleaned string", typeof body , JSON.stringify(body));

              $('#loaded').html(render(body));

              $('.putLink').click(function(ev){
                var delUrl = $(ev.currentTarget).text();
                var schema = {};  // TODO get the real schema
                var form = $(getInputForm('PUT', delUrl, schema));
                var submit = function(form){
                  console.log(uriParamNames);
                  var paramDict = {};
                  _.each(uriParamNames, function(name){
                    paramDict[name] = getUriParamFormField(name);
                  });
                  var submitUri = uriTemplate(delUrl)(paramDict);
                  console.log(form);
                  var body = $("form.inputForm textarea[name=body]").val();
                  console.log("body: ", body);
                  superagent.put(submitUri)
                    .send(body)
                    .set('Content-Type', 'application/json')
                    .end(function(res){
                      console.log("response: ", res);
                      alert('status: ' + res.status + "\nbody: " + res.body);
                    });
                };
                bootbox.dialog(form,
                              [
                                {
                                label : "OK",
                                 callback : function(){
                                   submit(form);
                                 }
                                },
                                {
                                 label : "CANCEL",
                                 callback : function(){
                                   return null;
                                 }
                               }
                                ],
                                {
                                  // prompts need a few extra options
                                  "header"  : "PUT ",
                                  // explicitly tell dialog NOT to show the dialog...
                                  //???  "show"    : false,
                                  "onEscape": function(){return null}
                                }
                                );
                /*, function(shouldDoIt){
                  if (shouldDoIt){
                    superagent.put(delUrl).end(function(res){
                      console.log("response: ", res);
                      alert('status: ' + res.status + "\nbody: " + res.body);
                    });
                  }
                });*/
              });
              $('.deleteLink').click(function(ev){
                var delUrl = $(ev.currentTarget).text();
                var confirmMsg = "Really delete " + delUrl + "?";
                bootbox.confirm(confirmMsg, function(shouldDoIt){
                  if (shouldDoIt){
                    superagent.del(delUrl).end(function(res){
                      console.log("response: ", res);
                      alert('status: ' + res.status + "\nbody: " + res.body);
                    });
                  }
                });
              });
            });
       }

       $(function(){
         var url = qs('href')[0] || '/';
         console.log("url : ", url);

         $('#urlField').val(url);
         retrieveUrl(url);


         $('#goBtn').click(function(btn){
          var url = $('#urlField').val();
          retrieveUrl(url);
         });
       
       });
    </script>
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/"><img src="img/headr-nav.png" /></a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active"><a href="/api/_util/?href=%2Fapi%2F">Home</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">
      <p>Location: <form>
        <input type="text" name="url" id="urlField" value="/" />
        <input type="button" id="goBtn" value="GO" />
      </form></p>
      <div class="row">
        <div class="span1">
          <h4>Status: </h4>
        </div>
        <div class="span1">
          <div id="responseStatus"></div>
        </div>
      </div>
      <h4>Body:</h4>
      <pre>
      <div id="loaded"></div>
      </pre>
      <div class="row">
        <div class="span12">
          <h4>Headers:</h4>
        </div>
        <div class="span12">
          <div id="responseHeaders"></div>
        </div>
      </div>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/bootstrap-transition.js"></script>
    <script src="js/bootstrap-alert.js"></script>
    <script src="js/bootstrap-modal.js"></script>
    <script src="js/bootstrap-dropdown.js"></script>
    <script src="js/bootstrap-scrollspy.js"></script>
    <script src="js/bootstrap-tab.js"></script>
    <script src="js/bootstrap-tooltip.js"></script>
    <script src="js/bootstrap-popover.js"></script>
    <script src="js/bootstrap-button.js"></script>
    <script src="js/bootstrap-collapse.js"></script>
    <script src="js/bootstrap-carousel.js"></script>
    <script src="js/bootstrap-typeahead.js"></script>
    <script src="js/bootstrap-affix.js"></script>
  </body>
</html>

