<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>percolator.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }

      pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
      .string { color: green; }
      .number { color: darkorange; }
      .boolean { color: blue; }
      .null { color: magenta; }
      .key { color: black; }

    </style>
    <link href="css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="ico/apple-touch-icon-57-precomposed.png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="js/superagent.js"></script>
    <script src="js/bootbox.min.js"></script>
    <script>

      function uriParse(uri){
        var parsed = document.createElement('a');
        // parsed has these properties:   protocol, hostname, port, pathname, search, hash, host
        parsed.href = uri;
        return parsed;
      }

      function qs(key) {
        var re=new RegExp('(?:\\?|&)'+key+'=(.*?)(?=&|$)','gi');
        var r=[], m;
        while ((m=re.exec(document.location.search)) !== null){
          r.push(unescape(m[1]));
        }
        return r;
      }

       function htmlEncode(str){
         return str;
         return str.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
       }

       function linkify(_links){
         console.log("links in: ", _links);
         for(linkname in _links){
           var v = _links[linkname];
           if (!!v.method && (v.method === "DELETE")){
             v.href = "<a class='deleteLink' href='#'>" + v.href + '</a>';
           } else {
             v.href = "<a href='?href=" + escape(v.href) + "'>" + v.href + '</a>';
           }
           if (v.method){
             v.method = '<strong>' + v.method + '</strong>';
           }
         };
         console.log('links out: ', _links);
         return _links;
       }

       function traverse(obj,func) {
         for (key in obj) {
           var value = obj[key];
           if (func.apply(this,[key,value])){
             if (typeof(value)=="object") {
               //going on step down in the object tree!!
               traverse(value,func);
             }
           }
         }
       }

       function render(obj){
         traverse(obj, function(key, value){
           console.log("called handler");
           if (key === "_links"){
             console.log("linkifying");
             obj['<strong>_links</strong>'] = linkify(value);
             delete obj._links;
             return false;
           } else {
             if (typeof value === 'string'){
               console.log("string: ", value);
               obj[key] = htmlEncode(value);
             }
             return true;
           }
         });

         console.log('pre-stringify: ', obj);

         var json = JSON.stringify(obj, null, 4);
         console.log('post-stringify: ', json);
         //json = htmlEncode(json);
         //console.log(json);
         /*
         json = json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
           var cls = 'number';
           if (/^"/.test(match)) {
              if (/:$/.test(match)) {
                  cls = 'key';
              } else {
                  cls = 'string';
              }
           } else if (/true|false/.test(match)) {
              cls = 'boolean';
           } else if (/null/.test(match)) {
              cls = 'null';
           }
           return '<span class="' + cls + '">' + match + '</span>';
         });
         */

         console.log(json);
         return json;
       }

       function headersToHtml(headers){
         var html = '';
         for(var k in headers){
           v = headers[k];
           html += '<dl class="dl-horizontal"><dt>' + k + '</dt><dd>' + v + '</dd></dl>';
         }
         return html;
       }

       function statusToHtml(status){
         var type = '';
         switch(true){
           case (status >= 200 && status < 300) : type = 'badge-success'; break;
           case (status >= 300 && status < 400) : type = 'badge-info'; break;
           case (status >= 400) : type = 'badge-important'; break;
         }
         return '<span class="badge ' + type + '">' + status + '</span>';
       }

       function retrieveUrl(url){
          superagent
            .get(url)
            .set('Accept', 'application/json')
            .end(function(res){
              $('#responseStatus').html(statusToHtml(res.status));
              $('#responseHeaders').html(headersToHtml(res.header));

              $('#loaded').html(render(res.body));

              $('.deleteLink').click(function(ev){
                console.log("deletelink clicked");
                console.log(ev);
                var delUrl = ev.currentTarget.innerText;
                var confirmMsg = "Really delete " + delUrl + "?";
                bootbox.confirm(confirmMsg, function(shouldDoIt){
                  if (shouldDoIt){
                    superagent.del(delUrl).end(function(res){
                      console.log("response: ", res);
                      alert('status: ' + res.status + "\nbody: " + res.body);
                    });
                  }
                });
              });
            });
       }

       $(function(){
         var url = qs('href')[0] || '/';
         console.log("url : ", url);

         $('#urlField').val(url);
         retrieveUrl(url);


         $('#goBtn').click(function(btn){
          var url = $('#urlField').val();
          retrieveUrl(url);
         });
       
       });
    </script>
  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/"><img src="img/headr-nav.png" /></a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active"><a href="/api/_util/?href=%2Fapi%2F">Home</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">
      <p>Location: <form>
        <input type="text" name="url" id="urlField" value="/" />
        <input type="button" id="goBtn" value="GO" />
      </form></p>
      <div class="row">
        <div class="span1">
          <h4>Status: </h4>
        </div>
        <div class="span1">
          <div id="responseStatus"></div>
        </div>
      </div>
      <h4>Body:</h4>
      <pre>
      <div id="loaded"></div>
      </pre>
      <div class="row">
        <div class="span12">
          <h4>Headers:</h4>
        </div>
        <div class="span12">
          <div id="responseHeaders"></div>
        </div>
      </div>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/bootstrap-transition.js"></script>
    <script src="js/bootstrap-alert.js"></script>
    <script src="js/bootstrap-modal.js"></script>
    <script src="js/bootstrap-dropdown.js"></script>
    <script src="js/bootstrap-scrollspy.js"></script>
    <script src="js/bootstrap-tab.js"></script>
    <script src="js/bootstrap-tooltip.js"></script>
    <script src="js/bootstrap-popover.js"></script>
    <script src="js/bootstrap-button.js"></script>
    <script src="js/bootstrap-collapse.js"></script>
    <script src="js/bootstrap-carousel.js"></script>
    <script src="js/bootstrap-typeahead.js"></script>
    <script src="js/bootstrap-affix.js"></script>
  </body>
</html>

